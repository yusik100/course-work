# Документація схеми бази даних

## Діаграма сутність-зв'язок (ERD)

![ER Diagram](img/er.png)

---

## Опис таблиць

### Таблиця: `Book`

**Призначення:** Зберігає інформацію про літературні твори (абстрактна книга, не фізичний примірник).

| Стовпець           | Тип     | Обмеження                                            | Опис                                |
| ------------------ | ------- | ---------------------------------------------------- | ----------------------------------- |
| `id`               | INTEGER | PRIMARY KEY, SERIAL                                  | Унікальний ідентифікатор книги      |
| `title`            | VARCHAR | NOT NULL                                             | Назва книги                         |
| `isbn`             | VARCHAR | UNIQUE                                               | Міжнародний стандартний номер книги |
| `publication_year` | INTEGER | CHECK (publication_year > 0)                         | Рік видання                         |
| `genre_id`         | INTEGER | FOREIGN KEY REFERENCES genres(id) ON DELETE SET NULL | Посилання на жанр                   |

**Індекси та обмеження:**

* `ix_books_title`: B-Tree індекс на поле `title` для швидкого пошуку.
* `ck_book_pub_year_positive`: CHECK-обмеження, що гарантує позитивний рік видання.

**Зв'язки:**

* *Багато-до-одного* з `Genre` (книга має один жанр).
* *Багато-до-багатьох* з `Author` через `book_authors` (одна книга — може бути декілька авторів).
* *Один-до-багатьох* з `BookCopy` (одна назва може мати багато фізичних копій).

---

### Таблиця: `BookCopy`

**Призначення:** Зберігає дані про конкретні фізичні примірники книг, що стоять на полицях.

| Стовпець           | Тип     | Обмеження                                          | Опис                                           |
| ------------------ | ------- | -------------------------------------------------- | ---------------------------------------------- |
| `id`               | INTEGER | PRIMARY KEY, SERIAL                                | Унікальний ID примірника                       |
| `inventory_number` | VARCHAR | UNIQUE, NOT NULL                                   | Інвентарний номер (наліпка на примірнику)      |
| `status`           | ENUM    | DEFAULT 'available'                                | Статус (available, on_loan, lost, maintenance) |
| `book_id`          | INTEGER | FOREIGN KEY REFERENCES books(id) ON DELETE CASCADE | Посилання на загальну інформацію про книгу     |

**Зв'язки:**

* *Багато-до-одного* з `Book`.
* *Один-до-багатьох* з `Loan` (копія має історію видач).

---

### Таблиця: `Reader`

**Призначення:** Зберігає персональні дані зареєстрованих читачів.

| Стовпець       | Тип     | Обмеження           | Опис                    |
| -------------- | ------- | ------------------- | ----------------------- |
| `id`           | INTEGER | PRIMARY KEY, SERIAL | Номер читацького квитка |
| `first_name`   | VARCHAR | NOT NULL            | Ім'я читача             |
| `last_name`    | VARCHAR | NOT NULL            | Прізвище читача         |
| `email`        | VARCHAR | UNIQUE, NOT NULL    | Електронна пошта        |
| `phone_number` | VARCHAR | NULL                | Контактний телефон      |

**Індекси:**

* `ix_readers_email`: унікальний індекс на `email` для швидкої аутентифікації/пошуку.

**Зв'язки:**

* *Один-до-багатьох* з `Loan` (читач може мати багато записів видач).

---

### Таблиця: `Loan`

**Призначення:** Реєструє факти видачі та повернення книг (транзакційна таблиця).

| Стовпець       | Тип         | Обмеження                                                 | Опис                                       |
| -------------- | ----------- | --------------------------------------------------------- | ------------------------------------------ |
| `id`           | INTEGER     | PRIMARY KEY, SERIAL                                       | Ідентифікатор запису видачі                |
| `borrowed_at`  | TIMESTAMPTZ | DEFAULT NOW()                                             | Дата та час видачі                         |
| `due_date`     | DATE        | NOT NULL                                                  | Гранична дата повернення                   |
| `returned_at`  | TIMESTAMPTZ | NULL                                                      | Фактична дата повернення (NULL — на руках) |
| `book_copy_id` | INTEGER     | FOREIGN KEY REFERENCES book_copies(id) ON DELETE RESTRICT | Яку саме копію взяли                       |
| `reader_id`    | INTEGER     | FOREIGN KEY REFERENCES readers(id) ON DELETE CASCADE      | Хто взяв                                   |

**Індекси та обмеження:**

* `ux_loans_active_per_copy`: частковий унікальний індекс `UNIQUE (book_copy_id) WHERE returned_at IS NULL` — гарантує, що одну й ту саму фізичну копію не можна видати двом людям одночасно.
* `ck_loan_returned_after_borrowed`: CHECK-обмеження, що `returned_at IS NULL OR returned_at >= borrowed_at`.

**Зв'язки:**

* *Множинні* зв'язки до `BookCopy` та `Reader` — цей журнал є асоціативною таблицею між копією і читачем з додатковими атрибутами (дати).

---

### Таблиця: `Author`

**Призначення:** Довідник авторів.

| Стовпець    | Тип     | Обмеження           | Опис              |
| ----------- | ------- | ------------------- | ----------------- |
| `id`        | INTEGER | PRIMARY KEY, SERIAL | ID автора         |
| `full_name` | VARCHAR | NOT NULL            | Повне ім'я автора |
| `bio`       | TEXT    | NULL                | Коротка біографія |

**Зв'язки:**

* *Багато-до-багатьох* з `Book` через `book_authors`.

---

### Таблиця: `Genre`

**Призначення:** Довідник літературних жанрів.

| Стовпець | Тип     | Обмеження           | Опис                                  |
| -------- | ------- | ------------------- | ------------------------------------- |
| `id`     | INTEGER | PRIMARY KEY, SERIAL | ID жанру                              |
| `name`   | VARCHAR | UNIQUE, NOT NULL    | Назва жанру (наприклад: "Фантастика") |

---

### Допоміжна таблиця: `book_authors` (Junction table)

**Призначення:** Реалізує зв'язок *Many-to-Many* між `Book` та `Author`.

| Стовпець    | Тип     | Обмеження                                                          |
| ----------- | ------- | ------------------------------------------------------------------ |
| `book_id`   | INTEGER | PRIMARY KEY, FOREIGN KEY REFERENCES books(id) ON DELETE CASCADE    |
| `author_id` | INTEGER | PRIMARY KEY, FOREIGN KEY REFERENCES authors(id) ON DELETE RESTRICT |

---

## Рішення щодо дизайну

### 1. Нормалізація та структура

* Схема спроектована відповідно до **Третьої нормальної форми (3NF)**: повторювані дані (автори, жанри, видавці) винесені в окремі таблиці-довідники.
* Розділення `Book` (логічний опис твору) і `BookCopy` (фізичний екземпляр) дозволяє уникнути дублювання даних при наявності багатьох копій однієї назви.

### 2. Забезпечення цілісності даних

* **ON DELETE CASCADE / RESTRICT / SET NULL** підібрані відповідно до бізнес-потреб:

  * Видалення книги призводить до видалення її копій (`CASCADE`).
  * Видалення жанру не знищує книги — поле `genre_id` стає NULL (`SET NULL`).
  * Видалення читача видаляє його історію видач (`CASCADE`).
* **Частковий унікальний індекс** на `loans` запобігає одночасній видачі однієї копії декільком читачам.

### 3. Стратегія індексування

* Частковий індекс: `ux_loans_active_per_copy` для активних позик.
* B-Tree індекси: `ix_books_title` для пошуку за назвою, унікальні індекси на `isbn`, `inventory_number`, `email`.

### 4. Перелічення (ENUM)

* Для `BookCopy.status` використано ENUM з набором значень: `available`, `on_loan`, `lost`, `maintenance`.
  Це забезпечує цілісність даних на рівні СУБД і стабільність бізнес-логіки.

---
